<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PricePulse - Live Amazon Price Tracker (INR)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .text-gradient { background-image: linear-gradient(to right, #4ade80, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
        .card { background: rgba(31, 41, 55, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .url-input { background-color: #1f2937; border: 1px solid #4b5563; }
        .url-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); }
        .spinner { border-color: #4f46e5; border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <div class="flex justify-center items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                <h1 class="text-4xl md:text-5xl font-black text-gradient">PricePulse</h1>
            </div>
            <p class="mt-2 text-gray-400">Live Amazon product price tracking dashboard (INR).</p>
        </header>

        <section class="max-w-2xl mx-auto mb-12">
            <form id="tracker-form" class="flex flex-col sm:flex-row gap-3">
                <input 
                    type="text" 
                    id="product-url" 
                    placeholder="Paste an Amazon.in or Amazon.com product URL..."
                    class="url-input flex-grow w-full px-4 py-3 rounded-lg text-white placeholder-gray-500 transition-all duration-300"
                    required
                >
                <button 
                    type="submit" 
                    id="submit-button"
                    class="bg-blue-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-2"
                >
                    <span id="button-text">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block"><path d="M5 12h14"></path><path d="M12 5l7 7-7 7"></path></svg>
                        Track Product
                    </span>
                    <span id="button-spinner" class="hidden">
                        <div class="spinner h-5 w-5 rounded-full border-2 border-t-2"></div>
                    </span>
                </button>
            </form>
            <div id="error-message" class="text-red-400 text-center mt-3 font-medium"></div>
        </section>

        <div id="loading" class="text-center my-10 hidden">
            <div class="spinner h-12 w-12 rounded-full border-4 border-t-4 mx-auto"></div>
            <p class="mt-4 text-lg font-semibold text-gray-400">Loading tracked products...</p>
        </div>

        <main id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>
        
        <div id="empty-state" class="text-center py-20 px-6 border-2 border-dashed border-gray-700 rounded-xl hidden">
             <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-600 mb-4"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path><path d="M18 14h-4"></path><path d="M20 12h-6"></path></svg>
            <h2 class="text-2xl font-bold text-gray-300">Your Dashboard is Empty</h2>
            <p class="text-gray-500 mt-2">Paste a product URL above to start tracking prices.</p>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('tracker-form');
        const urlInput = document.getElementById('product-url');
        const dashboard = document.getElementById('dashboard');
        const emptyState = document.getElementById('empty-state');
        const loadingIndicator = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const buttonSpinner = document.getElementById('button-spinner');

        // --- Configuration ---
        const API_BASE_URL = 'http://127.0.0.1:5000'; // Our Python server

        // --- Main form submission logic ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMessage.textContent = '';
            const url = urlInput.value.trim();

            if (!isValidAmazonUrl(url)) {
                showError('Please enter a valid Amazon product URL.');
                return;
            }

            // --- REAL API CALL ---
            setLoadingState(true);

            try {
                const response = await fetch(`${API_BASE_URL}/api/track-product`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });

                const productData = await response.json();

                if (!response.ok) {
                    throw new Error(productData.error || 'Failed to track product.');
                }
                
                // Scrape was successful, add the card
                const asin = _extractASINFromURL(url); // Get ASIN from URL
                addProductCard(productData, asin);
                urlInput.value = ''; // Clear input on success

            } catch (error) {
                console.error('Error tracking product:', error);
                showError(error.message);
            } finally {
                setLoadingState(false);
            }
        });

        // --- Helper Functions ---
        
        function setLoadingState(isLoading) {
            if (isLoading) {
                submitButton.disabled = true;
                buttonText.classList.add('hidden');
                buttonSpinner.classList.remove('hidden');
            } else {
                submitButton.disabled = false;
                buttonText.classList.remove('hidden');
                buttonSpinner.classList.add('hidden');
            }
        }
        
        function _extractASINFromURL(url) {
            const match = url.match(/(?:dp|gp\/product)\/([A-Z0-9]{10})/);
            return match ? match[1] : null;
        }

        function isValidAmazonUrl(url) {
            try {
                const parsedUrl = new URL(url);
                const hostname = parsedUrl.hostname;
                return (hostname.includes('amazon.com') || hostname.includes('amazon.in')) && (url.includes('/dp/') || url.includes('/gp/product/'));
            } catch (error) {
                return false;
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            setTimeout(() => { errorMessage.textContent = ''; }, 4000);
        }
        
        function formatToINR(amount) {
            return `₹${amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // --- UI Manipulation (Now uses REAL data) ---

        function addProductCard(product, asin) {
            if (!emptyState.classList.contains('hidden')) {
                emptyState.classList.add('hidden');
            }

            const cardId = `card-${asin}`;
            
            // Check if card exists to update it
            let card = document.getElementById(cardId);
            if (!card) {
                card = document.createElement('div');
                card.className = 'card p-6 rounded-2xl flex flex-col gap-4 fade-in';
                card.id = cardId;
                dashboard.appendChild(card); // Add new card
            }
            
            const latestPrice = product.lastPriceINR;

            card.innerHTML = `
                <div class="flex gap-4 items-start">
                    <img src="${product.imageUrl}" alt="${product.name}" class="w-24 h-24 object-contain bg-white p-2 rounded-lg shrink-0">
                    <div class="flex flex-col">
                        <h3 class="font-bold text-lg text-white leading-tight">${product.name}</h3>
                        <a href="${product.url}" target="_blank" class="text-xs text-blue-400 hover:underline">View on Amazon</a>
                    </div>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Current Price</p>
                    <p id="price-${asin}" class="text-4xl font-black text-green-400 transition-colors duration-300">${formatToINR(latestPrice)}</p>
                </div>
                <div class="flex-grow min-h-[150px]">
                    <canvas id="chart-${asin}"></canvas>
                </div>
            `;

            createPriceChart(asin, product.priceHistory);
        }

        function createPriceChart(asin, priceHistory) {
            const ctx = document.getElementById(`chart-${asin}`).getContext('2d');

            // Destroy existing chart if it exists, to prevent bugs
            let existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }

            const labels = priceHistory.map(entry => new Date(entry.timestamp).toLocaleString());
            const prices = priceHistory.map(entry => entry.price_r);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Price (₹)',
                        data: prices,
                        borderColor: '#4ade80',
                        backgroundColor: 'rgba(74, 222, 128, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: true, mode: 'index', intersect: false }
                    },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });
        }

        // --- Load Initial Data On Page Load ---
        async function loadTrackedProducts() {
            loadingIndicator.classList.remove('hidden');
            emptyState.classList.add('hidden');
            try {
                const response = await fetch(`${API_BASE_URL}/api/all-products`);
                if (!response.ok) throw new Error('Failed to load saved products.');

                const products = await response.json();
                
                if (Object.keys(products).length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    for (const asin in products) {
                        addProductCard(products[asin], asin);
                    }
                }
            } catch (error) {
                console.error('Error loading products:', error);
                showError(error.message);
                emptyState.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
        
        // --- Run on start ---
        loadTrackedProducts();

    });
    </script>
</body>
</html>